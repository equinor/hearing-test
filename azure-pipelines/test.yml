trigger:
  - develop

pool:
  vmImage: 'macos-latest'

variables:
  - group: AppiOS
  - name: SDK
    value: 'iphoneos'
  - name: AppName
    value: 'hearingtest'
  - name: BuildConfiguration
    value: 'test'

steps:

  - bash: 'cp app/env-configs/test.json app/settings.json'
    displayName: "Setting test environment > settings.json"

  - task: UseNode@1
    displayName: 'Specifying Node version'

  - bash: 'npm i'
    displayName: 'Installing JS dependencies with NPM'

  - task: InstallAppleCertificate@2
    displayName: 'Install Apple certificate - dd.mm.2021'
    inputs:
      certSecureFile: 'statoil_desi.p12'
      certPwd: '$(p12Password)'

  - task: InstallAppleProvisioningProfile@1
    displayName: 'Install Apple provisioning profile'
    inputs:
      provProfileSecureFile: 'HearingTest_Test.mobileprovision'


  - task: Xcode@5
    inputs:
      xcWorkspacePath: 'ios/madapp.xcworkspace'
      scheme: 'madapp'
      xcodeVersion: '10'
      packageApp: true
      exportPath: '$(agent.builddirectory)/output/$(SDK)/$(BuildConfiguration)'
      signingOption: 'manual'
      signingIdentity: 'iPhone Distribution: Statoil ASA'
      provisioningProfileUuid: 'f080d5ec-96a2-42e8-a434-84457aa23fcd'
      args: 'PRODUCT_BUNDLE_IDENTIFIER=com.equinor.$(AppName).$(BuildConfiguration)'

  - task: CopyFiles@2
    displayName: 'Copying our built files to: $(build.artifactstagingdirectory)/$(BuildConfiguration)'
    inputs:
      SourceFolder: '$(agent.builddirectory)/output/$(SDK)/$(BuildConfiguration)'
      Contents: '**/*.ipa'
      TargetFolder: '$(build.artifactstagingdirectory)/$(BuildConfiguration)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publishing the Artifact: drop'

  - bash: 'mv $(build.artifactstagingdirectory)/$(BuildConfiguration)/madapp.ipa $(build.artifactstagingdirectory)/$(BuildConfiguration)/$(appName)-$(BuildConfiguration).ipa'
    displayName: 'Rename app to $(appName)-$(BuildConfiguration)'


  - task: AppCenterDistribute@3
    inputs:
      serverEndpoint: 'AppCenter'
      appSlug: 'Statoil-ASA-Go-Digital/HearingTest-Test'
      appFile: '$(build.artifactstagingdirectory)/$(BuildConfiguration)/$(appName)-$(BuildConfiguration).ipa'
      releaseNotesOption: 'input'
      releaseNotesInput: |
        New update!
        Please test it.
      destinationType: 'groups'
