
# Triggers
# Learn more https://docs.microsoft.com/en-us/azure/devops/pipelines/build/triggers?view=azure-devops&tabs=yaml
trigger:
  batch: true
  branches:
    include:
      - master
    exclude:
      - f/*
      - bf/*
      - develop

# no PR triggers
pr: none

pool:
  vmImage: 'macos-latest'

variables:
  - group: AppiOS
  - name: SDK
    value: 'iphoneos'
  - name: AppName
    value: 'hearingtest'
  - name: BuildConfiguration
    value: 'prod'

steps:

  - bash: 'cp app/env-configs/prod.json app/settings.json'
    displayName: "Setting prod environment > settings.json"

  - task: UseNode@1
    displayName: 'Specifying Node version'

  - bash: 'npm i'
    displayName: 'Installing JS dependencies with NPM'

  - task: InstallAppleCertificate@2
    displayName: 'Install Apple certificate - dd.mm.2021'
    inputs:
      certSecureFile: 'statoil_desi.p12'
      certPwd: '$(p12Password)'

  - task: InstallAppleProvisioningProfile@1
    displayName: 'Install Apple provisioning profile'
    inputs:
      provProfileSecureFile: 'HearingTest_Prod.mobileprovision'


  - task: Xcode@5
    inputs:
      actions: 'build'
      xcWorkspacePath: 'ios/madapp.xcworkspace'
      scheme: 'madapp'
      packageApp: true
      exportPath: '$(agent.builddirectory)/output/$(SDK)/$(BuildConfiguration)'
      signingOption: 'manual'
      signingIdentity: 'iPhone Distribution: Statoil ASA'
      provisioningProfileUuid: '26ce6540-bd16-4830-9dc9-ceb94f5a06a0'
      args: 'PRODUCT_BUNDLE_IDENTIFIER=com.equinor.$(AppName)'

  - task: CopyFiles@2
    displayName: 'Copying our built files to: $(build.artifactstagingdirectory)/$(BuildConfiguration)'
    inputs:
      SourceFolder: '$(agent.builddirectory)/output/$(SDK)/$(BuildConfiguration)'
      Contents: '**/*.ipa'
      TargetFolder: '$(build.artifactstagingdirectory)/$(BuildConfiguration)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publishing the Artifact: drop'

  - bash: 'mv $(build.artifactstagingdirectory)/$(BuildConfiguration)/madapp.ipa $(build.artifactstagingdirectory)/$(BuildConfiguration)/$(appName)-$(BuildConfiguration).ipa'
    displayName: 'Rename app to $(appName)-$(BuildConfiguration)'


  - task: AppCenterDistribute@3
    inputs:
      serverEndpoint: 'AppCenter'
      appSlug: 'Statoil-ASA-Go-Digital/HearingTest-Prod'
      appFile: '$(build.artifactstagingdirectory)/$(BuildConfiguration)/$(appName)-$(BuildConfiguration).ipa'
      releaseNotesOption: 'input'
      releaseNotesInput: |
        New update!
        Please test it.
      destinationType: 'groups'
      distributionGroupId: '42417862-f1c1-4ee5-abc5-7945f9c2b992'
